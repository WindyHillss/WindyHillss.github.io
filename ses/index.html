<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Basit Sesli Sohbet - Çift Yönlü</title>
</head>
<body>
  <h1>Sesli Sohbet Testi</h1>
  <button id="start">Mikrofonu Aç ve Bağlan</button>
  <audio id="localAudio" controls autoplay muted></audio>
  <audio id="remoteAudio" controls autoplay></audio>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>

  <script>
    // Firebase config - kendi bilgilerinle değiştir
    const firebaseConfig = {
    apiKey: "AIzaSyACfKn20JKMDsHUSydz4E2xUlMqJyYuw1Q",
    authDomain: "voice-chat-40bf2.firebaseapp.com",
    databaseURL: "https://voice-chat-40bf2-default-rtdb.firebaseio.com",
    projectId: "voice-chat-40bf2",
    storageBucket: "voice-chat-40bf2.firebasestorage.app",
    messagingSenderId: "1082970978225",
    appId: "1:1082970978225:web:5fe993fe6bd9f2aeca2f90",
    measurementId: "G-F3EGYX8WVV"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const roomId = 'deneme-oda'; // Aynı oda ID’si
    const signalsRef = db.ref('rooms/' + roomId + '/signals');

    let localStream;
    let peer;
    let clientId = Math.random().toString(36).substr(2, 9); // Rastgele id

    document.getElementById('start').onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

      // Kendi sesini çal
      const localAudio = document.getElementById('localAudio');
      localAudio.srcObject = localStream;

      // İlk sinyali beklerken peer henüz yok, önceki sinyalleri temizle
      await signalsRef.remove();

      // İnisiyator mu, değil mi karar verelim
      // Oda boşsa initiator ol, değilse değil
      signalsRef.once('value', snapshot => {
        const hasPeers = snapshot.exists();
        startPeer(!hasPeers); // initiator = true eğer oda boşsa
      });
    };

    function startPeer(isInitiator) {
      peer = new SimplePeer({
        initiator: isInitiator,
        trickle: false,
        stream: localStream,
        config: {
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        }
      });

      peer.on('signal', data => {
        // Firebase’e sinyal gönder, kendi ID ile
        signalsRef.push({ from: clientId, signal: data });
      });

      peer.on('stream', stream => {
        // Uzak sesi çal
        const remoteAudio = document.getElementById('remoteAudio');
        remoteAudio.srcObject = stream;
      });

      // Firebase’den gelen sinyalleri dinle
      signalsRef.on('child_added', snapshot => {
  const msg = snapshot.val();
  if (msg.from !== clientId && peer && !peer.destroyed) {
    try {
      peer.signal(msg.signal);
    } catch (e) {
      console.error('Signal hatası:', e);
    }
  }
});

    }
  </script>
</body>
</html>
